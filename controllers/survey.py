countries = [
    ('IT', 'Italy'),
    ('AF', 'Afghanistan'),
    ('AL', 'Albania'),
    ('DZ', 'Algeria'),
    ('AS', 'American Samoa'),
    ('AD', 'Andorra'),
    ('AO', 'Angola'),
    ('AI', 'Anguilla'),
    ('AQ', 'Antarctica'),
    ('AG', 'Antigua And Barbuda'),
    ('AR', 'Argentina'),
    ('AM', 'Armenia'),
    ('AW', 'Aruba'),
    ('AU', 'Australia'),
    ('AT', 'Austria'),
    ('AZ', 'Azerbaijan'),
    ('BS', 'Bahamas'),
    ('BH', 'Bahrain'),
    ('BD', 'Bangladesh'),
    ('BB', 'Barbados'),
    ('BY', 'Belarus'),
    ('BE', 'Belgium'),
    ('BZ', 'Belize'),
    ('BJ', 'Benin'),
    ('BM', 'Bermuda'),
    ('BT', 'Bhutan'),
    ('BO', 'Bolivia'),
    ('BA', 'Bosnia And Herzegowina'),
    ('BW', 'Botswana'),
    ('BV', 'Bouvet Island'),
    ('BR', 'Brazil'),
    ('BN', 'Brunei Darussalam'),
    ('BG', 'Bulgaria'),
    ('BF', 'Burkina Faso'),
    ('BI', 'Burundi'),
    ('KH', 'Cambodia'),
    ('CM', 'Cameroon'),
    ('CA', 'Canada'),
    ('CV', 'Cape Verde'),
    ('KY', 'Cayman Islands'),
    ('CF', 'Central African Rep'),
    ('TD', 'Chad'),
    ('CL', 'Chile'),
    ('CN', 'China'),
    ('CX', 'Christmas Island'),
    ('CC', 'Cocos Islands'),
    ('CO', 'Colombia'),
    ('KM', 'Comoros'),
    ('CG', 'Congo'),
    ('CK', 'Cook Islands'),
    ('CR', 'Costa Rica'),
    ('CI', 'Cote D`ivoire'),
    ('HR', 'Croatia'),
    ('CU', 'Cuba'),
    ('CY', 'Cyprus'),
    ('CZ', 'Czech Republic'),
    ('DK', 'Denmark'),
    ('DJ', 'Djibouti'),
    ('DM', 'Dominica'),
    ('DO', 'Dominican Republic'),
    ('TP', 'East Timor'),
    ('EC', 'Ecuador'),
    ('EG', 'Egypt'),
    ('SV', 'El Salvador'),
    ('GQ', 'Equatorial Guinea'),
    ('ER', 'Eritrea'),
    ('EE', 'Estonia'),
    ('ET', 'Ethiopia'),
    ('FK', 'Falkland Islands (Malvinas)'),
    ('FO', 'Faroe Islands'),
    ('FJ', 'Fiji'),
    ('FI', 'Finland'),
    ('FR', 'France'),
    ('GF', 'French Guiana'),
    ('PF', 'French Polynesia'),
    ('TF', 'French S. Territories'),
    ('GA', 'Gabon'),
    ('GM', 'Gambia'),
    ('GE', 'Georgia'),
    ('DE', 'Germany'),
    ('GH', 'Ghana'),
    ('GI', 'Gibraltar'),
    ('GR', 'Greece'),
    ('GL', 'Greenland'),
    ('GD', 'Grenada'),
    ('GP', 'Guadeloupe'),
    ('GU', 'Guam'),
    ('GT', 'Guatemala'),
    ('GN', 'Guinea'),
    ('GW', 'Guinea-bissau'),
    ('GY', 'Guyana'),
    ('HT', 'Haiti'),
    ('HN', 'Honduras'),
    ('HK', 'Hong Kong'),
    ('HU', 'Hungary'),
    ('IS', 'Iceland'),
    ('IN', 'India'),
    ('ID', 'Indonesia'),
    ('IR', 'Iran'),
    ('IQ', 'Iraq'),
    ('IE', 'Ireland'),
    ('IL', 'Israel'),
    ('JM', 'Jamaica'),
    ('JP', 'Japan'),
    ('JO', 'Jordan'),
    ('KZ', 'Kazakhstan'),
    ('KE', 'Kenya'),
    ('KI', 'Kiribati'),
    ('KP', 'Korea (North)'),
    ('KR', 'Korea (South)'),
    ('KW', 'Kuwait'),
    ('KG', 'Kyrgyzstan'),
    ('LA', 'Laos'),
    ('LV', 'Latvia'),
    ('LB', 'Lebanon'),
    ('LS', 'Lesotho'),
    ('LR', 'Liberia'),
    ('LY', 'Libya'),
    ('LI', 'Liechtenstein'),
    ('LT', 'Lithuania'),
    ('LU', 'Luxembourg'),
    ('MO', 'Macau'),
    ('MK', 'Macedonia'),
    ('MG', 'Madagascar'),
    ('MW', 'Malawi'),
    ('MY', 'Malaysia'),
    ('MV', 'Maldives'),
    ('ML', 'Mali'),
    ('MT', 'Malta'),
    ('MH', 'Marshall Islands'),
    ('MQ', 'Martinique'),
    ('MR', 'Mauritania'),
    ('MU', 'Mauritius'),
    ('YT', 'Mayotte'),
    ('MX', 'Mexico'),
    ('FM', 'Micronesia'),
    ('MD', 'Moldova'),
    ('MC', 'Monaco'),
    ('MN', 'Mongolia'),
    ('MS', 'Montserrat'),
    ('MA', 'Morocco'),
    ('MZ', 'Mozambique'),
    ('MM', 'Myanmar'),
    ('NA', 'Namibia'),
    ('NR', 'Nauru'),
    ('NP', 'Nepal'),
    ('NL', 'Netherlands'),
    ('AN', 'Netherlands Antilles'),
    ('NC', 'New Caledonia'),
    ('NZ', 'New Zealand'),
    ('NI', 'Nicaragua'),
    ('NE', 'Niger'),
    ('NG', 'Nigeria'),
    ('NU', 'Niue'),
    ('NF', 'Norfolk Island'),
    ('MP', 'Northern Mariana Islands'),
    ('NO', 'Norway'),
    ('OM', 'Oman'),
    ('PK', 'Pakistan'),
    ('PW', 'Palau'),
    ('PA', 'Panama'),
    ('PG', 'Papua New Guinea'),
    ('PY', 'Paraguay'),
    ('PE', 'Peru'),
    ('PH', 'Philippines'),
    ('PN', 'Pitcairn'),
    ('PL', 'Poland'),
    ('PT', 'Portugal'),
    ('PR', 'Puerto Rico'),
    ('QA', 'Qatar'),
    ('RE', 'Reunion'),
    ('RO', 'Romania'),
    ('RU', 'Russian Federation'),
    ('RW', 'Rwanda'),
    ('KN', 'Saint Kitts And Nevis'),
    ('LC', 'Saint Lucia'),
    ('VC', 'St Vincent/Grenadines'),
    ('WS', 'Samoa'),
    ('SM', 'San Marino'),
    ('ST', 'Sao Tome'),
    ('SA', 'Saudi Arabia'),
    ('SN', 'Senegal'),
    ('SC', 'Seychelles'),
    ('SL', 'Sierra Leone'),
    ('SG', 'Singapore'),
    ('SK', 'Slovakia'),
    ('SI', 'Slovenia'),
    ('SB', 'Solomon Islands'),
    ('SO', 'Somalia'),
    ('ZA', 'South Africa'),
    ('ES', 'Spain'),
    ('LK', 'Sri Lanka'),
    ('SH', 'St. Helena'),
    ('PM', 'St.Pierre'),
    ('SD', 'Sudan'),
    ('SR', 'Suriname'),
    ('SZ', 'Swaziland'),
    ('SE', 'Sweden'),
    ('CH', 'Switzerland'),
    ('SY', 'Syrian Arab Republic'),
    ('TW', 'Taiwan'),
    ('TJ', 'Tajikistan'),
    ('TZ', 'Tanzania'),
    ('TH', 'Thailand'),
    ('TG', 'Togo'),
    ('TK', 'Tokelau'),
    ('TO', 'Tonga'),
    ('TT', 'Trinidad And Tobago'),
    ('TN', 'Tunisia'),
    ('TR', 'Turkey'),
    ('TM', 'Turkmenistan'),
    ('TV', 'Tuvalu'),
    ('UG', 'Uganda'),
    ('UA', 'Ukraine'),
    ('AE', 'United Arab Emirates'),
    ('UK', 'United Kingdom'),
    ('US', 'United States'),
    ('UY', 'Uruguay'),
    ('UZ', 'Uzbekistan'),
    ('VU', 'Vanuatu'),
    ('VA', 'Vatican City State'),
    ('VE', 'Venezuela'),
    ('VN', 'Viet Nam'),
    ('VG', 'Virgin Islands (British)'),
    ('VI', 'Virgin Islands (U.S.)'),
    ('EH', 'Western Sahara'),
    ('YE', 'Yemen'),
    ('YU', 'Yugoslavia'),
    ('ZR', 'Zaire'),
    ('ZM', 'Zambia'),
    ('ZW', 'Zimbabwe')
]

countrynames = [x[1] for x in countries]

response.menu = None

@auth.requires_login()
def demographic():
    surveyid = request.args[0]
    #check that the user is in that survey
    if not session.survey_stage:
        session.survey_stage = 1
    form=FORM(
              TABLE(
                  TR('Age',SELECT(value='23',_name='age', *range(15,100))),
                  TR('Gender',SELECT('Male', 'Female', _name='gender')),
                  TR('Education',SELECT('Primary school', 'Middle secondary school', 'High school', 'Bachelor degree', 'Master degree', 'Phd', 'Professor', _name='education', value='Bachelor degree',)),
                  TR('Nationality', SELECT(*countrynames, _name='nationality')),
                  TR('Average number of movies watched per month', SELECT(_name='number_of_movies_per_month', value='10', *(range(1,20)+['more than 20']))),
                  TR('','',INPUT(_type='submit'))
              ))
    if form.process().accepted:
        session.flash = 'form accepted'
        session.survey=surveyid
        if session.survey_stage < 2:
            session.survey_stage = 2
        redirect(URL('milo','default', 'index'))
    elif form.errors:
        response.flash = 'form has errors'
    else:
        response.flash = 'please fill the form'
    response.view = 'survey/form.html'
    return dict(form=form)


@auth.requires_login()
def catalogue_questions():
    if session.survey_stage < 3:
        session.survey_stage = 3
    form = FORM(TABLE(
        TR("Where you looking for specific items?", SELECT('No',
                                                           'Partially',
                                                           'Yes', _name="spec_item")),
        TR("Did you looked for movies that couldn't be found?", SELECT('No', 'Yes', _name="not_found")),
        TR("If yes, which ones?"),
        TR('',INPUT(_name="title1")),
        TR('',INPUT(_name="title2")),
        TR('',INPUT(_name="title3")),
        TR("Do you think that the catalogue appers to be complete?", SELECT("Highly complete",
                                                                            "Complete enough",
                                                                            "Partially complete",
                                                                            "Incomplete")),
        TR("Check the boxes you LIKED about the graphical interface"),
        TR(TD(INPUT(_type="checkbox"), "Color Palette")),
        TR(TD(INPUT(_type="checkbox"),"Text readability")),
        TR(TD(INPUT(_type="checkbox"),"Organizzation")),
        TR(TD(INPUT(_type="checkbox"),"Orientation guidelines")),
        TR("Check the boxes you DISLIKED about the graphical interface"),
        TR(TD(INPUT(_type="checkbox"),"Color Palette")),
        TR(TD(INPUT(_type="checkbox"),"Text readability")),
        TR(TD(INPUT(_type="checkbox"),"Organizzation")),
        TR(TD(INPUT(_type="checkbox"),"Orientation guidelines")),
        TR("Did you find confusing the browsing experience through the catalogue?", SELECT('No', 'Partially', 'Yes')),
        TR('','',INPUT(_type="submit"))
        ))
    if form.process().accepted:
        session.flash = 'form accepted'
        redirect(URL('rec_movies'))
    elif form.errors:
        response.flash = 'form has errors'
    else:
        survey = db.surveys[session.survey]
        schedule_recommendation(survey.algorithm, auth.user.milo_user, survey.number_of_ratings*2)
        response.flash = 'please fill the form'
    response.view = 'survey/form.html'
    return dict(form=form)


def next_movie():
    survey = db.surveys[session.survey]
    n_rec = survey.number_of_ratings
    if not session.recommendation:
        recommendation = db(db.recommendations.iuser==auth.user.milo_user).select().last()
        rec = recommendation.rec
        session.recommendation = rec
    else:
        rec = session.recommendation
    print rec
    if session.rec_seen == None:
        session.rec_seen = list()
    while True:
        for index in rec:
            if index not in session.rec_seen and db((db.ratings.imovie==index)&(db.ratings.iuser==auth.user.milo_user)).count() == 0:
                return index
        session.recommendation = None
        schedule_recommendation(survey.algorithm, auth.user.milo_user, survey.number_of_ratings*10)
        rec = [x.id for x in db(useful_movies).select(db.movies.id, limitby=(0,1000))]
    
@auth.requires_login()
def rec_movies():
    if session.survey_stage < 4:
        session.survey_stage = 4
    if session.movie:
        movie_id = session.movie
    else:
        session.movie = next_movie()
        movie_id = session.movie
        session.rec_to_do = db.surveys[session.survey].number_of_ratings
    if len(request.post_vars) != 0:
        #we are in the post
        #process form
        session.rec_to_do -= 1
        if db((db.ratings.imovie==session.movie)&(db.ratings.iuser==auth.user.milo_user)).count():
            session.rec_seen.append(session.movie)
        if session.rec_to_do == 0:
            session.rec_seen = None
            redirect(URL('local_info'))
        else:
            movie_id = next_movie()
            session.movie = movie_id
            
    movie = db.movies[movie_id]
    comments = db(db.comments.movie==movie).select()
    cast = movie.persons_in_movies(db.persons_in_movies.role.belongs(db.roles.name=='actor')).select()
    directors = movie.persons_in_movies(db.persons_in_movies.role.belongs(db.roles.name=='director')).select()
    return dict(movie=movie, comments=comments, cast=cast, directors=directors)

@auth.requires_login()
def local_info():
    if session.survey_stage < 5:
        session.survey_stage = 5
    form = FORM(TABLE(
        TR('Where did this survey take place?', SELECT('University', 'Home', 'Work place', 'Public place', 'Other')),
        TR('Why did you accepted to take part to the survey?', SELECT('Friend request', 'Interest in movies', 'Other')),
        TR('','',INPUT(_type="submit", value="Finish"))
        ))
    if form.process().accepted:
        session.flash = 'Thank you for participating to this survey!'
        session.survey = None
        session.survey_stage = None
        redirect(URL('default', 'index'))
    elif form.errors:
        response.flash = 'form has errors'
    else:
        response.flash = 'please fill the form'
    response.view = 'survey/form.html'
    return dict(form=form)
